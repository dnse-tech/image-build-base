name: Release s390x

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., v1.25.6b1)"
        required: true
        type: string

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/hardened-build-base
  UPSTREAM_IMAGE: rancher/hardened-build-base

jobs:
  build-s390x:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}
      go_version: ${{ steps.get-tag.outputs.go_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get tag
        id: get-tag
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Extract Go version: v1.25.6b1 â†’ 1.25.6
          GO_VERSION=$(echo "$TAG" | sed -E 's/^v([0-9]+\.[0-9]+\.[0-9]+)b[0-9]+$/\1/')
          echo "go_version=$GO_VERSION" >> $GITHUB_OUTPUT
          echo "Tag: $TAG, Go Version: $GO_VERSION"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push s390x image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/s390x
          push: true
          build-args: |
            GOLANG_VERSION=${{ steps.get-tag.outputs.go_version }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.get-tag.outputs.tag }}-s390x

  create-manifest:
    runs-on: ubuntu-latest
    needs: build-s390x
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and tag upstream amd64 image
        run: |
          TAG="${{ needs.build-s390x.outputs.tag }}"

          # Pull upstream amd64
          docker pull --platform linux/amd64 ${{ env.UPSTREAM_IMAGE }}:$TAG
          docker tag ${{ env.UPSTREAM_IMAGE }}:$TAG ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG-amd64
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG-amd64

      - name: Pull and tag upstream arm64 image
        run: |
          TAG="${{ needs.build-s390x.outputs.tag }}"

          # Pull upstream arm64
          docker pull --platform linux/arm64 ${{ env.UPSTREAM_IMAGE }}:$TAG
          docker tag ${{ env.UPSTREAM_IMAGE }}:$TAG ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG-arm64
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG-arm64

      - name: Create and push multi-arch manifest
        run: |
          TAG="${{ needs.build-s390x.outputs.tag }}"

          docker buildx imagetools create -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG-amd64 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG-arm64 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG-s390x

          echo "Created multi-arch manifest: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG"

      - name: Verify manifest
        run: |
          TAG="${{ needs.build-s390x.outputs.tag }}"
          docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG

  release:
    runs-on: ubuntu-latest
    needs: [build-s390x, create-manifest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build-s390x.outputs.tag }}
          name: Release ${{ needs.build-s390x.outputs.tag }}
          body: |
            ## Docker Images

            Multi-architecture image available on GHCR:
            ```
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-s390x.outputs.tag }}
            ```

            Supported architectures:
            - linux/amd64 (from upstream rancher/hardened-build-base)
            - linux/arm64 (from upstream rancher/hardened-build-base)
            - linux/s390x (built by this workflow)

            ## Go Version
            Go ${{ needs.build-s390x.outputs.go_version }}

            ## Notes
            - s390x image includes Trivy scanner (v0.68.2+)
            - s390x image does NOT use BoringCrypto (not supported on s390x)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
